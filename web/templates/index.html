<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>D√©tection de site web de phishing</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    .empty {
      text-align: center;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <h1>D√©tection de site web de phishing</h1>
    <a href="{{ url_for('afficher_stats') }}">
      <button>üìä Voir les statistiques</button>
    </a>
    <a href="{{ url_for('profile_user') }}">
      <button>Aller au profil</button>
    </a>
  </header>

  <main>
    <h2>Bienvenue sur le syst√®me de d√©tection de site web de Phishing</h2>

    <!-- Section de recherche et filtres -->
    <section class="search-filter">
      <form id="filterForm" method="get" style="display: flex; gap: 10px; align-items: center;">
        <input
          type="text"
          id="searchInput"
          name="search"
          placeholder="üîç Rechercher une URL, IP, etc."
          value="{{ request.args.get('search', '') }}"
        />

        <select id="filtreSelect" name="filtre">
          <option value="">-- Filtrer --</option>
          <option value="Phishing" {% if request.args.get('filtre') == 'Phishing' %}selected{% endif %}>Phishing</option>
          <option value="Legitimate" {% if request.args.get('filtre') == 'Legitimate' %}selected{% endif %}>L√©gitime</option>
          <option value="HTTP" {% if request.args.get('filtre') == 'HTTP' %}selected{% endif %}>Protocole : HTTP</option>
          <option value="HTTPS" {% if request.args.get('filtre') == 'HTTPS' %}selected{% endif %}>Protocole : HTTPS</option> 
        </select>

        <button type="submit">APPLIQUER</button>
        <button type="button" id="resetBtn">RESET</button>
      </form>
    </section>

    <!-- Section des alertes -->
    <section class="alerts">
      <br />
      <h3 class="section-title red">üö® CAPTURES R√âCENTES</h3>


      <section class="export">
        <a href="{{ url_for('export_csv') }}" class="btn btn-primary">
          <button>üì§ Exporter CSV</button>
        </a>

        <a href="{{ url_for('export_json') }}" class="btn btn-success">
          <button>üì§ Exporter JSON</button>
        </a>
      </section>

      <table id="detectionsTable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>IP Source</th>
            <th>IP Destination</th>
            <th>Protocole</th>
            <th>URL</th>
            <th>Verdict</th>
          </tr>
        </thead>
        <tbody id="detectionsBody">
          <tr><td colspan="6" class="empty">Chargement des donn√©es...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer>
    {% if session.get('user_id') %}
    <button class="logout-btn">
      <a href="{{ url_for('logout') }}">Se d√©connecter</a>
    </button>
    {% endif %}
    <p>¬©Ô∏è 2025 Syst√®me de d√©tection de phishing</p>
  </footer>

  <script>
    const detectionsBody = document.getElementById('detectionsBody');
    const searchInput = document.getElementById('searchInput');
    const filtreSelect = document.getElementById('filtreSelect');
    const resetBtn = document.getElementById('resetBtn');
    const filterForm = document.getElementById('filterForm');

    async function chargerDetections() {
      try {
        const response = await fetch('/detections_json');
        if (!response.ok) throw new Error('Erreur lors du chargement des d√©tections');
        const detections = await response.json();

        const search = searchInput.value.trim().toLowerCase();
        const filtre = filtreSelect.value.toLowerCase();

        const detectionsFiltres = detections.filter(d => {
          const rechercheOk = !search || 
            d.url.toLowerCase().includes(search) || 
            d.ip_src.toLowerCase().includes(search) || 
            d.ip_dst.toLowerCase().includes(search);

          const verdict = d.verdict ? d.verdict.toLowerCase() : '';
          const protocole = d.protocole ? d.protocole.toLowerCase() : '';
          const filtreOk = !filtre || verdict === filtre || protocole === filtre;

          return rechercheOk && filtreOk;
        });

        detectionsBody.innerHTML = '';

        if (detectionsFiltres.length === 0) {
          detectionsBody.innerHTML = '<tr><td colspan="6" class="empty">Aucune d√©tection trouv√©e.</td></tr>';
          return;
        }

        detectionsFiltres.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.timestamp}</td>
            <td>${d.ip_src}</td>
            <td>${d.ip_dst}</td>
            <td>${d.protocole}</td>
            <td>${d.url}</td>
            <td>${d.verdict}</td>
          `;
          detectionsBody.appendChild(tr);
        });

      } catch (error) {
        detectionsBody.innerHTML = '<tr><td colspan="6" class="empty">Erreur lors du chargement des donn√©es.</td></tr>';
        console.error(error);
      }
    }

    // Chargement initial
    chargerDetections();

    // Recharge toutes les 5 secondes
    setInterval(chargerDetections, 5000);

    // Emp√™che la soumission par d√©faut et applique les filtres
    filterForm.addEventListener('submit', function(e) {
      e.preventDefault();
      chargerDetections();
    });

    // R√©initialisation des champs
    resetBtn.addEventListener('click', () => {
      searchInput.value = '';
      filtreSelect.value = '';
      chargerDetections();
    });
  </script>
</body>
</html>
